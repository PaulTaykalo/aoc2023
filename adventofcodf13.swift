import Foundation

// Set buffet to immediately flush output
setbuf(stdout, nil)

let inputTest = """
???.### 1,1,3
.??..??...?##. 1,1,3
?#?#?#?#?#?#?#? 1,3,1,6
????.#...#... 4,1,1
????.######..#####. 1,6,5
?###???????? 3,2,1
"""

let input = """
.???##?????????#?.?? 1,12
#####??.?????? 7,1
#.???#???.#? 1,2,1,1
?#???#?..???# 2,1,1,1
?#..???.#?.?.. 1,2,2,1
?#?????#?#??#?????# 2,1,8,1,1
?#???????? 1,4,1
#???#??#?##.???? 1,1,7,1,1
?#?.#???#?###??? 2,3,8
.??#????#. 3,1
??#.??#??#?? 1,1,2,1
?#??#?#??.?.#.#?? 8,1,1,3
????###??#.???#..?? 7,3,1
.##????.?? 3,2,1
#.#???#?##??.????.? 1,2,7,1,2
.#?.??#?????.??.?? 2,8,1
#???..?.?. 3,1
????#?#???..??? 1,6
?????#???.??.???? 6,1,1,1,2
?..?.#????#?###?#? 1,1,1,10
.#??#?????#. 4,5
.?????????. 1,4
.??.?.#?#??. 1,4
??##???.#???#??.? 5,3,2,1
?#????#??.? 1,4,1
#??#.??###???. 4,5,1
?#?.#??.???# 3,2,3
?#??.???#??? 1,1,5
???.#????.? 2,4,1
???#?.#??#???#?.?# 1,1,1,1,3,1
???.#???.?#???? 1,1,3,2,1
.#??##????. 5,2
?????#???????.??? 3,4,1,1,3
?...???####????#? 1,13
.?##?#????????#???. 6,6
???.?#???? 2,3,1
.????????#???? 5,3,1
..?#??..??.?? 4,1,1
.?#???.?#? 2,1,1
#??..???????#? 2,1,5
??#????..??.???. 3,1,1,1
..#??.????? 3,3
.#?????#?..?.#?? 2,1,3,1,1
##???..????? 4,2
???????????#.? 1,5
.#?#???????#???? 3,1,5,1,1
?????#?????. 2,2,1
?.?????###?? 2,4
???????#???#?????? 1,1,7,1,1
?#????##?????????? 9,1,1,1
???????.??#????#? 6,2,1,1
?#???..??????? 4,3,1
.#?????#?# 4,4
???????.???????. 2,3,2,3
????#?#????????.??# 12,1,1,1
.##..?.?##?#?.?.# 2,4,1,1
#?##??#??.# 8,1
?????.??#????? 1,1,6
??.?..?#?.??. 1,2,2
????#??..????? 2,1
?.#???##???.? 1,1,2,1
????????#?? 1,1,4
?#???.??###????.? 4,5,1
??.?.??#?#.???#???? 1,1,1,3,6,1
.???#????????? 1,7
?###????#?????.?#. 4,8,2
?#?????????? 8,1
?.#?#???###?.???? 1,8,1
????#?.#???????.?? 1,8
#????????.?#??# 2,1,1,2,1
?.??.??#..?#.??? 1,1,2,2,2
?????.#??.?? 1,3
##??.?###????? 4,7
?.?#?###??? 1,2,3
.?????.???#? 2,4
.??#.?##???#?? 1,5,1
?##.??#????#???????# 3,5,1,1,1,2
#??#???#.???###???? 1,1,2,5,1,1
??.??.?????##?.?? 1,1,5,2
.#??.??#???##?#.?#? 1,1,2,2,1,2
??????####??##..?? 14,1
????.??#?????#??... 1,1,6,1,1
??#?.??.#.. 3,1
.#?#????????.. 5,4
???#?????#??#? 2,7
????#?????#?#??#.? 8,1,1,1,1
?#?????##.?????????? 9,1,1,1
?#????.??#?#.??.# 1,1,5,1,1
?????#?..? 1,3
?.???#?#????##? 8,3
???..?..??#?.#??##?. 2,1,4,6
?###??.?#?#?????? 5,4,2
?..##???????????? 4,5
.??#.????????#..???? 1,6
?###??????.????? 10,3
?.#.??.?????#..??. 1,2,2,1,1,1
??#???????#.# 8,1,1
??.#?...?#????? 1,1,2,4
.??????#????? 8,2
?#?#??..??.??# 3,1,3
.?????.????. 1,2
?????..??????? 1,2,3,1
..#?.??#.##??#??? 1,1,1,6
????.?.?..? 2,1,1
.#???.??.??? 1,1,1,1
?.???#..??????? 1,3,6
.?#.??..?? 1,1,1
????????.#? 3,1
???#?????? 1,2,2
???#####???#?.?#.??. 12,1
????..??.? 2,1
.???????.???? 3,1,2,1
??#?#???#??#??.???. 8,1,1,3
?????###.???? 8,2
.??..?.?#?? 2,3
#?.????..? 1,2,1
??????????##.#?#. 1,8,1,1
.#????##??.?.#?? 1,1,4,1,2
?###???.??.???.? 3,1,1,1,1
.#?.?#???????? 2,1,2,3
#???#?##???#?#??. 8,5
.?#???????????.#?#? 4,2,3
?##.??..??? 2,1
?..???????????? 1,2,2,1,1
.#?.??#??? 2,2
???.???.???..#????? 2,2,1,1,3,1
?#??????#. 3,4
?.????#?#?????# 7,5
??#????.?#??.. 2,2,3
.#?????#??#??#??.?? 1,4,1,2,1,2
???..?#???? 3,1,1
#??#??????...?? 1,1,3,1,1
?#??.?..#??????# 4,3,4
??.??.??????.? 2,3,1
..#?..?#???. 1,2
.?????#?.? 3,1
?#??#??#?#?#.??? 1,9
##???.????.?#??.??? 4,1,1,3,1
.?.?.?.????????? 1,1,4,1
??.#????#.???##???.? 1,3,1,1,5,1
#.??#?.?.?..? 1,2,1,1
???.#?.???. 1,2,2
?..#?.?#??????? 1,2,6
#?.?##?#?? 1,3,1
#?#.???#?#???.? 3,5,2,1
##..?.????##?#?#???? 2,1,1,9,1
.?#????.???? 2,4
???..###?#??# 2,5,2
#???.????#??? 4,2,1,1
..?#??????..? 2,4
??...????#.?? 1,3,1,1
?.??##?#???.??????? 6,7
???#?.?????#? 1,1,1,1
??#?????????.??#?.?? 1,1,2,4,3
?????#?#??#??????? 1,4,1,6,1
?#???#.?#??? 2,1,1,3
?##.??#?????.???. 2,3,3
??#????.??? 1,5,1
??##?????????????? 3,3,1,5
???.?##????? 1,5,1
?#??#.???#?????## 1,1,6,3
.?.??#?.???#?? 2,4
???##???.??????#???? 7,1,1,5
??????#????.?..? 3,1,3,1,1
?#??##???.???#.????# 7,1,1,1,1,1
???????#.??? 1,6,2
.#.?#?.?#? 1,1,1
?#???#????#?.#?????? 10,1,2,1
.?#?####??#???????. 6,9
#?..?#.?#?#????#? 1,2,8
.??#?##?.????#??#. 2,2,8
????#..???????? 1,1,2,2
??#???#..?##????? 1,2,1,8
.????????##???. 6,4
????#?...??.?.?#.# 5,1,1,1,1
??.?????..#?? 1,1,1,3
?????.???? 3,1
.????????.??.???? 1,4,2,1,1
?#??#???.????????? 7,2,2
???#????.#.??##??? 4,1,4
#??##..#?????. 1,2,2,1
???????#???.?.?#?. 4,2,1,3
??.???#.?.???. 2,3,3
???.???#???.??##? 1,7,4
????##.?#??##..?? 6,1,2,1
.??.???#????#.?.? 2,1,3,2,1
????????#?#?#? 2,5,4
.???????.?#?#?. 5,5
?.###???.???????##?? 5,1,1,6
??????#??#??#???.#? 1,1,9,1
?#???#.?????# 6,2,2
???.#??????. 2,3,1
.????##?????.? 9,1
????#..#.??? 1,1,1,1
?##?..???????????#.? 4,9
?#?????.?? 3,2,2
#??????#??????.? 8,1,2,1
?#.?#?????#..#??? 2,4,2,1,1
#????????????.#?? 1,6,2,3
???#???.#.? 4,1
?#??#?#.???#??????. 6,4,2
??##???????#????.?# 1,8,1,2,2
?#????#?#.???.?# 2,4,1,1
?##????#?# 3,5
?.?..??#.#?. 1,1,1,1
?#.???????.?? 2,3
?#???#????.? 8,1
?#?.??????#. 1,6
#?#.???.?? 3,3,1
?.#?????????????#? 10,1
???????#??.?#?? 2,4,2
?#???##??##??#???#?? 8,2,1,3,1
?#???#???##? 2,6
??.???##?. 2,3
?????????.???..?#?? 7,1,1,3
.?#??..??#?? 4,3
???.???#????.???? 1,5,2,1
?#.???##???#.. 2,6
?#?.???.??#??#.??.. 2,3,3,1,1
?#???????##???.??#? 14,1
#?.#????..?.? 1,1,2
??..???????#?.??. 1,7,1
?#??#??????#.????? 2,1,1,3,1,1
?..??.??#?.?? 1,1,3,1
????.??##?#?#??. 2,8
??????##?#?? 1,1,7
???##?.#?#??????#??? 3,13
??#????#????.??. 3,1,2,1,1
???.??????..?.? 2,1,1,1,1
#???###???????. 1,6,2
??#?#.##???.????##? 3,1,4,1,4
?.????##????????##?? 4,7
?.###?#.?#??#.??#??. 1,5,3,1,4
.?.?#????? 1,1,3
...??.???. 2,2
.?????#??? 2,2
??????##?#..?????#.? 4,4,1,1,2,1
??##?#??.?.?? 6,1
.???##????..??#???#? 5,7
#???#????? 5,1,1
????????#?. 3,5
?.??#???##?.??? 1,1,1,5,2
???????#?.?. 1,1,2,1
?.##?#.??#?#?.. 4,6
?##??????#.?????? 7,1,2,1,1
?.??????..???.?..? 2,1
?..?????#??? 2,2,1
??#..????? 1,1,1
???????#?.?? 9,1
????#??.??. 6,1
#.?....??????#?? 1,8
?###?#?????##??? 13,1
???.??.???##? 1,5
##.?.?.?##??#?##???? 2,1,10,2
?#??.?.?.? 2,1
???#??#??????.?? 1,1,3,4,1
#?##???#?#.???##? 8,1,4
????.###.????## 1,3,1,1,2
????????.????##?#?? 1,2,1,1,2,6
?.???#?????. 4,1
????#?.??.##?? 1,1,2,3
#??????.??# 3,3,2
..####.#?#.?????##?. 4,1,1,6
??????????#?????? 1,3,2,2,3
?.??#???#?#??????#. 3,10
?#?.#???????#??# 2,4,1,1,1
??????????? 7,1
..??..#?#??#???#??## 2,14
?#?#.????? 1,1,2
#??#??#??#.#?.?.#.?. 7,1,1,1,1,1
??????#?.??.#.????? 1,4,2,1,5
?#????#??? 1,1,3
#?#??#??..??.#???? 8,1,4
??#??#?#?#???#????? 2,1,11
?##??#?#.?????.?? 7,2
#????##?..?. 1,5
????#?#???????#??? 8,1,1,2
???.????.?##????# 1,1,2,4,3
??????##?###?? 1,1,9
???#?.??#?#.?.????# 1,3,1,3,1,1
.#???????##?#?. 10,1
????#???.?????#??? 2,3,2,2
##?.????#?#?? 2,2,5
.?????#???#??#?.#? 1,1,6,2,2
?.??#??.??#?#?#?#?? 1,1,2,11
.?#???#?..? 2,3
.??.??#.?? 2,1
?????#?..?? 1,2,1
.##???#????.#.??? 2,5,1,1
??.??##?????. 2,4,2
..##.??#????????#.?? 2,1,10,1
???###?#??#. 1,8
??..??##??.? 1,4,1
?.?#?#..???#?.#??. 1,3,5,1
??????#?????? 1,1,1,4
??.#???????????#? 1,10,1
???.?????.????????.. 1,5
???####.????? 6,2
#?##?.?????????? 4,2,3
???.?#????.??.?#.? 3,1,3,1,2,1
????????.?.?. 7,1
?.?##?#??.??#?#?#?? 1,6,5,2
.??#???..?#??...??# 2,4,1
#.???????# 1,6
?#.??##.??.????? 1,2,1,2,1
?.?..???#?????? 6,3
?.??#?#?#?? 1,7
???#???#.?#?.???#.# 1,5,1,1,1,1
??.?????#??????.?.? 1,1,4,1,1,1
.?.?????.??# 1,2,1,2
???..#?#?# 1,3,1
?..#?#???????#? 1,4,1,1,1
??#?.???#???#?? 3,4,1,1
????#???????#??????. 1,13,2
?.???#????..?. 1,8,1
??.?#?.?.???##?.?# 1,2,1,6,1
???..???#???###?#??? 2,13
...##??#?.??. 5,1
???.?#?#?? 1,4
?#??????.#? 2,1,1
##?#????#? 4,4
???.#?##????#??????. 1,5,4,1,1
#.??????#. 1,1,1
??????.?..#????#? 4,2,1
??????????##???. 2,1,7
?#?????????? 2,5,1
?.?.????#??? 1,5,1
????.#??##?..?.? 2,6,1
????????#???? 1,1,1,5
.?.????##???#?.??? 1,10,1,1
?.?????#?? 2,2
.????.#??.??#?? 2,2,4
#??.#????#?#????.. 1,12
?##?.??##????? 2,6
?.??.#?#??#####?.# 1,10,1
.??#.?????? 2,4
?????#???.?.##? 1,4,2
??..???..?.??#??. 1,2,3
???##?##?#?#??????.. 1,13
????.?.??.#?#?##???# 1,1,1,10
??#.?????##???????.? 3,11
.?.?..??#??#??? 1,7
??#?#.???.?##??? 1,1,1,1,4
???????#??? 2,4
.?#??##??#?????? 1,5,1,1
?#?#???#?#?.#?#?# 5,3,5
.?..??#?#???#???. 1,10
????#?#?#??.?? 1,4,2,1
?????.#??#??#??? 2,8
??.?#?????????#???.# 1,13,1
?????#????#?? 1,1,5
?????#???.??#?? 5,2,3
?.?.????#.. 1,4
??.???????#????.#?? 2,1,1,1,2,2
???.#???????#. 1,1,5
????#?#.?#??.???.?? 1,5,1,1,1,1
.??.#???.#??#??.?# 1,1,1,4,1,1
????.?????##?? 2,1,4
??..??????.??? 1,3,2,2
????.?????. 4,2
????..??????##??? 4,1,1,4,1
??..??#?##??.#?? 6,3
#?.?##?#?..??#? 1,6,2
?#???????#.# 2,2,2,1
???..?.??. 1,1,1
.???????.? 1,1,1
?#????????##? 1,2,3
??????#???.?.?##?#. 1,7,3,1
#??????#??? 1,6
?..???#??????? 5,1
??.???.??#??# 2,1,3,2
#?.?#?????#?##???.?. 1,2,8
.#??#???.???.? 1,2,3
#????????#??? 5,3,1
??????#???###. 7,5
????##?????###? 1,4,1,4
?????.????#?#??.? 3,1,1,5,1
??#?#??????#?.?. 2,1,1,1,2
#??????#?.?#? 1,4,2,1
?#???#...???? 2,1,3
???.??##???#.??? 3,1
??.?#?.???#?#?##??# 1,3,1,1,1,5
?..????.?? 2,2
???.?????? 1,1,1
??#??????.????. 7,3
??.????????..??.?#?? 1,1,1,2,2,3
??#.???.?? 1,1,1
?????????#????.?##?? 1,1,7,1,3,1
??????#??##?## 2,1,1,6
#?????.?#???.? 6,4
.?#??#.?#????. 2,1,3
??#?.??#?? 3,3
??#??##??#. 4,3,1
???#????.?.?????.?? 1,3,1,2,1,1
?#?.???????#. 2,8
??.#?????????????#?? 3,3,6
?.??###??#. 5,1
????.?#??? 4,3
?.?.????#???#.# 1,1,1,3,1
.##???#.????. 4,1,1,1
??#?##??????#?? 1,6,1,1
?#??##?..??#?. 5,3
#?#????#.#??#? 3,2,1,4
??#???#?.? 1,2
??##?#?.#?#???? 1,4,3,1,1
?#??.???###??. 3,5
??.?.?????#????.? 2,4
#???.??#?#???.???? 3,6
?#?#????#.?#???##??? 4,1,10
??.#????????#??.? 1,1,1,6,1
??#??#.????.??. 3,2,1,2
?#.?#?????.#? 1,3,1,1
????.??.?????.?? 2,2,3,1
?#.????..???.# 2,2,1,1
?.??##??#??????. 3,1,2,2
?????#.?##????#.? 2,1,6,1,1
.?###??????.?#? 8,1
.??..##???#?#?? 2,9
.??#?####???.?.? 8,1,1,1
??.?.?.#.? 2,1,1
??????.??#??? 4,1,3
??.?????????..??? 1,2,1,3,1
?.???#??..??##??..? 1,1,1,1,6,1
###???#???????#...#? 13,1,2
#?###?????#?????##? 1,6,4,1,2
.?...?.#??.??##?.? 1,2
??.?.??#.??.? 3,1
??????.?#?##??.? 3,1,6,1
??????#?#.??#?#.. 2,1,2,1,5
?#??#.?.??###???##?? 2,1,1,4,6
#?...?#?#. 1,4
#??#????#?.??.???. 1,7,2,3
??????????#??.?. 1,8,1
????????#??.?.??#.?? 7,2
??#??#?.??#??#???#? 4,10
#?#.?#????? 3,2,2
??#.?????.???? 2,1,1,2
.?#???.#????#?? 2,6
???.?.##??.???? 1,2,1,1,1
???????###.#..#?. 2,2,3,1,2
??#?#??...?#.. 4,1
??..???????.?. 1,1
????#?#??? 3,3,1
????##???? 2,3,2
??.#??.?????#?#? 1,1,1,3,1
.?.??.???. 1,2
??.??#?????? 2,2,1
.?????#.?##??#?#??# 2,1,2,4,1
???#???#???#.??.#?#? 2,7,1,3
?##.?.?.#??#.?#?? 2,1,1,2,2
????.?##.??. 3,2,2
.?#?#?????????##??. 7,1,5
??????###?#??? 3,8
?????#??#.???.?#?.?. 9,1,3
..??##..###?#??? 3,5,1
.##?.#.???.? 2,1,1
..##??#?.???#???. 5,6
???????????#????# 1,5,2,2,2
??##???#????????#?? 1,6,1,1,1
.#????????#. 3,1,1
?#???????.????# 2,1,1,2,1
??.?#????##? 2,4
#?#?????????##?##.? 1,1,1,1,8,1
??.#???#??.#?. 1,4,1
?.?.????#..?? 1,4
????..#??????##??.?. 1,1,11
?#????.?.? 4,1,1
#?????#????#??.???.? 1,1,7,1,1
.??.#?.#????#.#???? 1,2,6,1,1
??#???#??? 5,1
??????#.?????? 6,1
?#??????#?#.?.. 1,4
.?????.??..???#???? 3,1,6
?#?.??#?#?#??#.??. 1,1,8,1
???.#.??.???#??? 3,1,1,6
??#?#????.?? 6,1
?????##????#?#?#??. 4,8
.?#???????#.?#.??#?? 7,1,1,1,1,1
?##?#??#.??# 5,1,3
?.#?????#???????##?? 1,2,11
??#???#??. 1,3
.?.???#???#.#?..? 1,4,1,2
#??.#??????. 1,2,1,1
.??#?###????#? 1,4,3
??.???.?.????.? 1,2
?.?#??.??#.?? 3,1,1,1
?#.????#????. 1,4,1,1
.?##??.?.?#.?# 5,1,2,1
????#???????.?##?. 10,2
???.?#???.????###?# 1,1,2,1,8
?..?#?.##?? 2,3
???????????.#??#?# 2,1,1,1,4,1
???..???.????#? 1,3
.#???#?#?# 1,5
???.#?.#??#??##.?.? 1,1,8
????????#????.?#???? 7,5,4
???.????#?#?? 1,3,4
?..?#?????.##?? 6,3
?????????.???????? 1,1,4,1,2
????#??#?.??#.? 3,1,3
??#..????? 3,3
??#.??#???.#??. 3,3,1,1
??#?.???#?????? 1,1,7,1
????#??#?.????.??#?? 7,1,1,1,1
.??#???#??#?????#?? 2,11
.?#?#?#??? 3,3
????#???##. 3,2
.?#??#???????? 4,6
.??.???###?. 2,5
??.?.?????#?#??? 1,8
???..???#?#?..?#?? 3,1,1,2,2,1
????.?#???##?##? 1,1,1,1,5
?????????????????# 1,1,3,1,5,1
#??#.?#.?. 1,1,1
????.#??#??.??.? 2,4,1
??#?#.?????. 1,3,4
#?#???#?????#.?? 1,7,1,1
?#??????#?? 2,1,1
?????????.###.???? 1,5,3,1,1
??????##??.?#.?? 1,7,2,1
?.??.??????.???? 1,2,2,3
.??????##???..??##? 8,4
.???.?.#??????#???# 2,1,4,7
?#.#????#???? 1,4,5
?..#??##??#?.?#?#??? 1,1,2,2,4,1
??..??????.?? 1,5
???.????#.??#?#????? 2,1,1,10
???????...?# 2,1,2
#.?#??#?#?#?#?.??? 1,4,1,3,1
.??#??.#?# 4,1,1
??????????.????.? 1,4,1,1,1
?????.????#??? 3,2,2
???#??????#????#??? 11,1,2
.?.#?#?#.?. 1,3
??.????##??..# 1,1,4,1
?????#??##??.?#? 1,10,2
..#??#?????? 4,2
.?#??.???#?? 3,5
.?????.??? 1,1,2
?????????. 1,1,2
???.???.?#?.??? 3,1,2,1
???#??.?#?.#.? 2,1,2,1
.#????#???#????? 3,2,3,3
??????#?#.??? 1,4
?.????#??##. 1,2,5
?.??#?#.?? 3,1
????#?#????.#???#?.? 3,4,1,6
????#?#?#?#?#??#??. 9,8
?..?#..### 1,1,3
.????????#?? 7,1,1
?.?#??#??.?????? 3,1,1,1,1
?#??.#?#???#??? 3,1,1,3
?#?.????#?#???.? 2,6,1
??.???.?????? 1,2,2,1
?#??..??????#?# 2,1,2,2,1
??#?????#???#???#?#? 12,2,1
??#???.?#??? 1,4,2
???...#..?#??? 3,1,3
##?.#?#?##????##??? 2,6,3,1
.#?#?.?.???#?#?## 4,8
##??.??????#. 3,6
?#???..#.#.??##?? 1,1,1,1,5
??#??#?#?.#?.#??#?? 1,7,2,1,1,1
.?.???????##??.?? 1,2,3,2
??#????#????.??. 8,1,1
???#?.?#???? 2,2
???#?#?#????? 7,2
????.????? 3,1
###?#?#????? 3,4,2
??#?#??#.?.#?#?##?. 5,2,7
.??.???#..???#??.? 1,1,1,5,1
?#?..???.? 1,3
..?##?.??..#?#?##?#? 3,1,9
?.??.?##??. 1,3
????#???###??.?# 1,1,4,2
#??#...???? 1,1,3
?????..#?# 4,1,1
??#?#?.??.. 4,1
..?#.??#?? 2,2
???.?????#??#?? 1,6,2,1
???.#?##???#??? 2,11
???#????#?#????#??? 2,9,5
??.???.??????? 1,2
??##?...????#?? 4,4
??#??#????? 5,1
?##.??.?.#.?.? 2,2,1,1
.?#.??#???.#?#?..?? 2,5,3,1
?#???##?????#? 9,2
??#??.#?#?.??# 4,1,1,2
#.?#?????? 1,1,1
????#???????.??.? 11,1
??.?#?#???#??#? 2,10
?#??#??#??#??#??#? 8,1,5
?#?#?#?????????#.??# 1,7,1,1,2
.??.???#?. 2,1,1
??...??#?#. 1,4
.??.#????.?.? 1,2,1,1
??#?#.?#???###?#? 3,7,1
?????#???###?.??? 2,1,6,2
?#?#???#.???#?.?.# 8,1,1,1
?.??#?#?#??###??# 1,14
#.??#????????.. 1,5,1
##?#???????#???##??? 9,4,2
.??..???#?? 1,3
##????.?????. 2,1,3
.???.??????.#???## 1,3,1,1,4
#.?##??#??##? 1,7,2
?#??#????? 2,4
.?#???#??#??#?#. 7,4,1
????#?.#??#.. 1,2,1,1
??.?##.?#??#?? 3,1,3
?.????.??#?#????.??? 3,5,1,3
?????#..?###?.???.?# 2,3,5,1,1,2
#?.?.#?.?#?? 1,1,1,1
?#?.???.##.?.?.? 2,2,1,1
#?#???.?#.?????? 4,1,2
?.??????.??? 1,2
.#????#??#?##?.? 2,1,5,1
???#?#???.#. 1,1,1,1
?##??##??????.???? 7,1,2,1,2
#????##?#?..#?#??. 9,1,1
??#??.??#??#????# 1,2,1,1,4
.????#???#???? 5,1,1
???#?.?..???????# 3,4,2
????#?#??#??.????.. 7,2
#?#????#.???..#? 5,1,2,2
?#?#?#??.??????.. 5,1,2
??#??????? 1,5
..??##??.?#??..??? 3,2,1
#????.??????#? 1,1,4,1
?#.#??????#? 1,1,1,3
??.??.???#???. 1,2,1,4
??#?#?????? 4,3
?????.?.??#? 1,1,1,1
??##??#???#?? 6,1
?.????###??#??? 3,1
??????????#??.#? 3,1,1,2,1
????#?.???##?? 1,1,6
?.?#?.??#?????? 2,2,2
#.??##?#?????#?????? 1,10,2,1,1
?.??#???..???? 1,1,2
.##????.??? 4,1
#???..???#??#???#??? 1,1,1,1,9
#.#??#???????#.#?#?. 1,7,2,1,2
??#??#?????#?###??? 5,3,7
?#?#?.??.??? 1,1,1,1
..#????????# 1,2,3,1
?.??#.?#??? 2,2
.#?????.?##???#?? 6,8
?.???#????..??????? 4,1,3,2
????.???#???..? 1,1,2,1,1
#???#??????????? 1,2,1,6
?.??.???#? 1,4
??#????#.??? 4,1,1
????.??.?#??.??? 1,1
#.?.?#??????.?#?.? 1,2,3,3
?##??##??.?..? 2,4,1
???.??#?????###?#?# 1,13,1
????????.?????????#? 2,1,1,9
?#?#??#?????#????? 2,2,1,1,3,3
??..#??.???.???## 3,2,3
?.?#?#???#? 4,1
.?#??#???#??????#.? 10,4
???????????##???.? 1,1,1,1,3,1
..?#??.#???????#?? 1,1,7,1
?????#?#?????? 1,3,2
.??????????.#?????? 2,4
??.#?#?.?.???? 4,2
???#????.?#???# 1,1,3,3,1
??.??????.???.?? 1,3,2
?#.#?????#???###? 2,1,11
????.#?.#????##???.# 2,1,2,5,1
??.##????##?... 3,4
..?#??.??.?##??#??.? 4,6
?#?????????#?. 6,3,2
??.##????????####??# 1,15,1
???.?.????? 1,3
???#?#.?##?? 5,3
.??#?..##? 4,3
?????#??#????.##? 6,2,2,2
??.#??#???##.#. 1,3,2,1
?#.?.????.?. 1,2,1
??.?????????. 2,3,2,1
????#???.? 1,2,1
??????.#???. 1,1,3
#..?.??#?? 1,3
..#.?????????. 1,4,2
?.??????#?????.? 7,2,1
?#??.?.#?###??? 1,1,1,5
.??.?#.??.?.???...?. 2,1
???#?.#?#?.??..?#.? 1,3,4,2,2,1
..??..?#??. 1,4
.??#?????.??????? 6,3
?..??????..???.? 1,2,3
#?????.?#?????#????. 1,1,1,12
?????????.?#??????? 1,5,7
???.?#.???.??? 2,2,2,3
??.?.?.??#.???? 1,3,2
??.????##????# 1,6,1
?.???????.?#. 1,2,1,1
..??#.????.?????? 3,1
??#?#?.###?#??#?#.?? 4,5,2,1,1
??#?..???? 3,2
?#?##.???.#.??##???# 5,1,1,1,4,2
.#.?#?.??# 1,2,3
#?.##??..#???.???#?? 1,2,1,4,3
??#??????????????? 3,1,1,2,1,1
.??.#?.?#??# 1,1,3,1
?.?#??#???????#????? 1,5,3,4,1
???#????#??? 4,3,1
.??#???.??#? 2,4
##?.??.#??#??? 2,1,6
#??#..##..?#. 1,1,2,1
?#?.#?#??#??##.???#? 2,3,2,2,4
..????????.?.??.?#? 1,1,3,1,1,3
#??.??????# 2,5
?.###???????? 3,1,2
.?#??#?#???..????? 2,7,3
?#?##?#??.##?..?#?? 7,2,3
??#?.??..?#?#.# 1,1,4,1
??#????????#.? 9,1
##?#?##????????????? 8,1,1,2,3
#????#?????#???? 9,1,1
?#..???#?.#???#?##?# 1,1,1,10
?.?????##.?#?? 1,4,2
?.????????? 5,2
?#?#?????.??#?##?? 4,2,8
???.#??#.?#??#?.??? 2,1,1,5,2
?#??.?????????#. 4,2,4
.##?????.#.?. 2,3,1
.##..????.? 2,3
?#?#???.????.???? 4,2
##?.???.????? 2,1,5
?#??.?#??? 1,1,5
?.????#??..#?..? 2,1,2
#??????#.. 1,2,1
???#??..?#??? 1,1,3,1
??#???.#??? 6,1,1
???#?????????????? 3,2,6,2
#??????.?????? 4,1,1,1
?????#?#?? 2,6
?##?#???????.???? 2,2,1,1,4
?..?????#?.? 1,3
##..#?.??. 2,2,2
..#??????? 1,2,1
..?????##.. 2,3
??#???????#? 1,3,2,1
#??.#???????????? 3,3,1,4
#??.??#.???? 2,1,2
?????#?.????? 1,2,1,1
????#?##???##??#? 6,8
?.??#?.?????.. 2,4
??.?????#??#? 1,1,5
??????#.#???.?#??? 2,1,1,4,1,1
?#??.???#???..?# 1,1,2,1,2
##???.???###? 2,1,1,4
##?????????????##?#. 5,1,1,7
??..???#???????????? 1,4,1,1,3,1
?..??#??.?##?? 1,1,1,3
.?.??.???#.?.?? 2,1
??????????? 1,4
????#.???? 3,1
??#??????#??.? 2,8,1
.????#?#??????. 6,3
??#?###?.?.???#????? 8,1,1,4,1
????.?#???. 1,5
?.????#????. 1,7
????.????? 3,1
?.#..##??#????? 1,1,9
#?#?#??????##?????? 1,1,10,1,1
??.???.#?? 2,1
.?#????#.???.?.# 4,2,2,1,1
.????#.??? 1,3,1
???????????#???? 1,6,3,1
???.#?.????. 2,2
??#?????#??? 8,1
???????????. 1,1,2,3
???#.????.#?.??# 3,3,1,1,1
????#??..?.#?. 3,1
.##?????#?????.?.?#? 9,2,1,1
????.???????#?? 2,1,6
..??.?#??? 1,2,1
#?.???#.????##. 1,1,1,1,2
?.???#????# 1,1,6
?.????????? 1,6
???#?##???#????.?.? 9,2,1
?.#?#.?????#???###? 1,1,1,1,1,8
???#.?.??.#? 4,1,2,1
???..?..?# 2,2
?????????? 1,2,1
..???#?????#... 1,7
??.????.#????? 1,3,1,3
.?#???#??? 2,1
?????????.??????? 2,1,3,1,5
???.??????#???? 2,6
??##???#?#? 3,1,2
?...?#?.???... 3,2
???#?..?##?? 2,3
#?#??????#???#??#?? 4,13
?????#????. 1,1,1
.?.#?#????#?????.??? 1,6,1,2
????#??????.?? 8,1
.?#???#???.#?# 2,1,1,3
????#.????? 5,1,1
.?#???.?###?.??# 3,5,1
?#???#??????#??.#. 8,4,1
??????#.#???.?? 1,5,2,1,1
#???##.?##?? 1,3,4
#.?.?.???????? 1,1,4,1
?#????#??#?? 2,3,3
#??#???????.#?? 1,1,1,2,1
.????????? 1,1,1
???#?????..??. 9,1
..?#??#?.??..???. 6,2
?.?#????????.?...?? 4,4,1,2
#?.????.??# 1,4,2
.?#?.??.#?????? 1,1,1,4
..#?????.??#???.## 2,1,1,1,1,2
.#???????.?#??. 6,1,3
.#??#?.#?????#??.??? 1,1,1,7,1
?#???.?.?#??? 1,2,1,4
#?.???????????????? 1,2,6,1
???#.??..?? 4,1
#???.#????.? 2,1,2,1
.#??????.#??.? 2,2,2
?.?????#??#.??#?.? 2,4,4
.#???????##. 1,1,2
?#??????.#.##? 2,4,1,3
?#????.???#? 5,3
?.??#?#??##.#? 1,4,2,1
???#?#?##??????? 1,6,1,1,1
?..#?.#?#? 1,1,2
????.??.#?? 1,2,1
?#?.?.#?...?? 2,1,2,2
?????????#???. 1,1,1,5
.?#????.???#?? 6,1,2
??.?#????.???#. 1,4,1,1
.???#??.?????### 4,8
??##?????#??? 8,3
?#???????##.? 3,4
??.#???#??#?. 5,1
?#.????#????#.???. 1,1,6,2
???????#???#?? 3,6
??#.?#.???? 2,1,2
????????.?#??????.?? 1,1,1,1,6,1
.?.??????????#?? 5,4
?#?..???#??#??#??? 2,11
??#???.???#??#??? 2,2,6
##?#??##??#?????..?. 9,2,1,1,1
#??????.?.#??#? 1,2,1,1,1
.???.??#?.#?? 1,1,2,1
.???#.?#??#?#??# 4,1,4,2
?.?#???????????.? 2,2
?.????#??????.?? 4,1
?#????????#?.?.# 6,2,1,1,1
..????#?????#. 5,1,1
????#.#???????????? 1,1,1,1,8,1
?...?#?#??? 1,3
?#?????#..?.?? 7,1
??#??????.#?#?#?.?? 4,2,6,1
???#???.??. 4,1,1
???#???#?#?#?#??#??? 2,1,3,9
??.????.???##?# 2,6
???.#????#?#??#??.# 1,1,1,10,1
??????????.??#?#?? 2,5,4
??#????????#?# 1,5,3
????.?..#??? 2,3
.?#??#??.???..?# 1,2,1,2,1
#????????????###?#?? 3,14
???????..?????##?? 2,2,9
?##?#?.???.????.??# 5,1,1,2,1
???#.????###?###.??. 1,1,1,8,1
?#??????#??#? 2,1,6
?..?..??#. 1,1,1
#???????????.?? 1,6,1
.???.?????? 1,3,1
?.????#????##??.? 1,8,1
??#?.?.???.?..? 2,1
?????#????????? 1,1,1,2,1
???????????.?.?# 1,5,1,1,1
??#??.??#??#?????? 3,1,4,2
.????##???# 4,1
???#.?#??.???????# 2,3,5,1
?????#.#?.?.#???. 6,2,4
?.??#????.#??#???# 4,8
#???.?#.#??#.??##?? 1,1,1,4,2,1
?#?.##..#?##.?# 2,2,4,2
???.??????.??????#?# 1,1,1,1,1,9
?.?#??#?#.#? 1,1,3,2
?#????.?#???? 4,3
??#?#?#?.????? 7,1,1
##?#??#??.? 8,1
??#.?###?#?.? 2,6
#?##????????#. 7,1,1,1
??..#???##???.?#???? 1,3,2,2,5
??#?#?.????#?# 3,1,2,4
??????##??.#???? 3,3,3
?#???#.?????#?? 4,1,5
??.??#???????.?#. 1,6,1,2
..??????????#?## 8,1,2
.#???.##??.?#??#?? 3,2,1,1,2
?#???##?.. 1,1,2
.????#?.?##??#..??? 6,6,1
??#???##.?.###??#? 7,4,1
?????????#?#???? 9,1
?#?##?#???#?.. 7,2
.#?.?.????? 1,1,2
?#.?#????#.?? 1,3,1,2
.????#??.??#..??? 4,3,2
???????.?#??###??. 6,7
.???##???#?? 1,4,1
????#?###???#? 1,1,1,7
#?.?.?.?#? 1,1,1
?.##?#?.?#??.#. 4,2,1
??.???.??#?##?.???# 2,2,6,1,1
.???.#..#???.?? 2,1,1,1,1
?#????.?.?# 2,1,2
??#????#?#?.??. 3,1,1,2,2
???.????#.????? 1,4,2
.??##????#?.???. 5,4,1
?##??#????#??# 2,2,1,4
?#????.#?#???#?? 2,2,7,1
????#..?#? 4,3
#.?.#?????#? 1,1,2,3
??#??????#?.??? 5,1,1,1,1
??????#.#? 1,2,2
??#.??????#? 3,4,2
#?????#??.?.##????? 1,1,4,1,5,1
??.??.???#???##????. 1,6,4
.?#?.?..?#? 2,3
?#??????.?#?.# 5,1,2,1
??#????#??.#?#? 7,3
??#??#?.????#? 1,2,5
???.???..??????? 2,3,3
???#???#??? 1,7
#???.???#??? 1,2,1,3
?????.?.#??.??# 2,2,1,2,2
??.?#?????????#??##? 1,16
??.???????????? 2,6,3
?????#?????##?..??# 1,1,2,7,1,1
.#?.??????##??.?.?? 1,2,5,1,1,1
?#???.????.? 1,1,4,1
????????#?#????? 1,1,11
????###.?#??.#? 1,3,2,1
#??.???#??????? 3,4,3
?#?????..? 2,1,1
????##????#???????## 3,3,8,2
?????.??###????? 2,4,1
.?#??#???.?? 2,1,1,1
????#??.?????. 5,1,1
?#?????.??.????# 5,1,1,1,3
?##.??????# 3,5
??##???#????.?#.?? 7,3,1,1
?..#.??##???.?? 1,7,1
?#?##?????#??.?# 1,10,1
??.?#?#.????#??. 4,1
.?????#?##.??. 1,7
???#.???.?#????? 1,5
#?.???????.??? 1,1,5,1
?##??#???## 7,2
#?##??????.. 7,1
#...????????##?##?? 1,3,7
???#?????#?????#? 3,8
?#???#??#.????.??# 1,1,4,1,1,1
??#??#?????????? 4,1,1,1
?.?????##????##????? 1,1,8,2,1,1
?????#???? 5,1
?.??.###?##??#? 1,1,3,2,2
????.??..?? 4,1,2
??.????#.?# 5,2
#.#??.?????? 1,1,1,2
..#??#??.??????#??? 6,6
.#?.??##???.#?#. 2,3,1,3
?????.??.?????????.? 3,7
.##?#????# 4,1
?#???#??#??.#.?# 2,1,3,1,1
??????#???. 1,1,4
.#??###?????#?? 1,11
.????#?????#?##.??.. 10,2,1
??.##?.???#????.# 1,2,8,1
.??#?????????.? 1,1,4,1,1
?#?##?.???? 4,1
.??????#?.?#? 5,2
?.???###.????.?.? 1,6,3,1,1
##??##????????##?#? 7,1,6,1
??#??????????###?? 2,1,1,6
?.??.#.??#????. 1,1,1,1,2
????????.??#? 8,1,1
?.??????.##??#.#?.# 1,1,2,5,1,1
..?#?#???.??.??.?? 6,1
.????#.##?#?##.#??? 1,1,1,7,1,2
??#???#??#?#??? 12,1
#???????????#?#????? 1,2,1,1,6,1
???#..?????#??. 1,1,7
??##???###??.?#?#?.? 12,4,1
??????#.?##.?#???#? 1,2,2,3,1
??.??.?##???????#. 2,1,11
.??#????##??? 3,4
.??#???#????#??.? 14,1
?#????..#??????.. 2,1,7
"""

let input3 = """
??#??#?? 2,1
"""


struct Record: CustomStringConvertible{
    let input: String
    var arrangement: [Int]

    var description: String {
        return "\(input) \(arrangement)"
    }
}

func isValid(_ input: String, placement: [Int]) -> Bool {
    let groups = input.split(separator: ".").filter { !$0.isEmpty }
    guard groups.count == placement.count else {
        return false
    }
    return zip(groups, placement).allSatisfy{ (group, count) in
        return group.count == count
    }    
}

func placementVariants(_ input: String, placement: [Int]) -> Int {
    var inp = input
    if let index = inp.firstIndex(of: "?") {
        inp.replaceSubrange(index...index, with: "#")
        let one = placementVariants(inp, placement: placement)
        inp.replaceSubrange(index...index, with: ".")
        let two = placementVariants(inp, placement: placement)
        return one + two
    }

    if isValid(inp, placement: placement) {
        return 1
    } else {
        return 0
    }
}

var memo: [String: Int] = [:]

func placementVariants2(_ input: [Character], placement: [Int], level: Int = 0) -> Int {
    let memoKey = String(input) + placement.map(String.init).joined()
    
    if let cachedResult = memo[memoKey] {
        return cachedResult
    }

    func log(_ input: @autoclosure () -> String) {
        // let prefix = Array(repeating: "  ", count: level).joined()
        // print("\(prefix)\(input)")
    }

    guard let currentPlacement = placement.first else {
        // TODO: Check if input is empty ?/: thinking:
        let hasSharp = input.contains { $0 == "#" }
        return hasSharp ? 0 : 1
    }

    // log("Input: \(input), placement: \(placement), currentPlacement: \(currentPlacement)")


    let minimumPlacements = placement.reduce(0, +) + placement.count - 1
    let spaceLeft = input.count - minimumPlacements

    guard spaceLeft >= 0 else {
        // log("No space left :()")
        return 0
    }
    var sum = 0

    for i in 0...spaceLeft  {

        if i > 0 && input[i - 1] == "#" {
            break
        }

        // Make sure that we have enough place for the rest of the placements
        if placement.count > 1 {
            // log("About to check lasst at \(i + currentPlacement)")
            let last = input[i + currentPlacement]
            guard last == "." || last == "?" else {
                continue
            }
        }


        if input[i] == "." {
            continue
        }

        let canBeCorrectlyPlaced = input[i..<i+currentPlacement].allSatisfy { $0 == "#" || $0 == "?" }
        guard canBeCorrectlyPlaced else {
            continue
        }

        let separator = placement.count == 1 ? 0 : 1 
    
        // log("Forming input :  nin \(i + currentPlacement + separator), max \(input.count)")
        let nextInput = Array(input[i + currentPlacement + separator..<input.count])
        // log("Forming placement")
        let nextPlacement = Array(placement.dropFirst())

        sum += placementVariants2(nextInput, placement: nextPlacement, level: level + 1)

    }

    // log("Sum: \(sum) for input: \(input), placement: \(placement)")

    memo[memoKey] = sum
    return sum
}



var map = inputTest.split(separator: "\n").map { String($0) }
// map = input3.split(separator: "\n").map { String($0) }
map = input.split(separator: "\n").map { String($0) }

var records = map.map {
    let parts = $0.split(separator: " ")
    let input = String(parts[0])
    let arrangement = parts[1].split(separator: ",").map { Int($0)! }
    return Record(input: input, arrangement: arrangement)
}

// // Updated records

records = records.map {
    // miltiple 5 times
    Record(input: Array(repeating: $0.input, count: 5).joined(separator: "?"), 
    arrangement: Array(repeating: $0.arrangement, count: 5).flatMap { $0 })
}

print("Records\n:\(records.map { $0.description }.joined(separator: "\n"))")

var sum = 0
for record in records.enumerated() {
    var r = record.element
    print("Starting with \(r.input) and \(r.arrangement)")
    let result = placementVariants2(r.input.map {$0}, placement: r.arrangement)
    // let result2 = placementVariants(r.input, placement: r.arrangement)
    let result2 = result
    print("Result[\(record.offset)]: \(result) vs \(result2)")
    if result != result2 {
        print("    ^^ ERROR")
    }
    sum += result
}

print("Sum: \(sum)")


// MARK: - Private ======================================================================================

enum Direction {
    case up
    case down
    case left
    case right
}


struct Coord: Hashable, Equatable, CustomStringConvertible {
    var x: Int
    var y: Int
    init(x: Int, y: Int) {
        self.x = x
        self.y = y
    }

    func top() -> Coord {
        return Coord(x: x, y: y - 1)
    }
    func bottom() -> Coord {
        return Coord(x: x, y: y + 1)
    }
    func left() -> Coord {
        return Coord(x: x - 1, y: y)
    }
    func right() -> Coord {
        return Coord(x: x + 1, y: y)
    }

    mutating func move(_ direction: Direction) {
        switch direction {
            case .up:
                y -= 1
            case .down:
                y += 1
            case .left:
                x -= 1
            case .right:
                x += 1
        }
    }

    var description: String {
        return "(\(x), \(y))"
    }
}

extension String {
    func components(withMaxLength length: Int) -> [String] {
        return stride(from: 0, to: self.count, by: length).map {
            let start = self.index(self.startIndex, offsetBy: $0)
            let end = self.index(start, offsetBy: length, limitedBy: self.endIndex) ?? self.endIndex
            return String(self[start..<end])
        }
    }
}